<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.kh.petvely.dao.PostDAO">
    <insert id="insertPost">
    	insert into post(po_title, po_co_num, po_content, po_me_num,  po_viewCount, po_recommendCount, po_delete)
    	values(#{po_title}, #{po_co_num}, #{po_content}, #{po_me_num}, #{po_viewCount}, #{po_recommendCount}, #{po_delete})
    </insert>
    
    <!-- 삭제되지 않은 게시글 목록 조회 (po_delete = 0 조건 추가할 예정) -->
	<select id="selectPostList" resultType="PostVO">
		 SELECT p.*, 
           (SELECT COUNT(*) FROM recommend WHERE re_po_num = p.po_num AND re_state = 1) AS recommendCount,
           (SELECT COUNT(*) FROM recommend WHERE re_po_num = p.po_num AND re_state = -1) AS notRecommendCount
    	FROM post p
		where po_co_num = #{co_num}
		
		
	</select>
	
	<!-- 삭제되지 않은 게시글 목록 조회 (and po_delete 추후 추가예정) -->
	<select id="selectPost" resultType="PostVO">
		
		select * from post 
		where po_num = #{po_num}
	
	</select>
	
	<update id="updatePost">
		update post set po_title = #{po_title}, po_content = #{po_content}
		where po_num = #{po_num} 
	</update>
	
	<update id="updateView">
		update post
		set
			 po_viewCount = po_viewCount + 1
		where
			 po_num = #{po_num}
	</update>
	
	<!-- 게시글 논리적 삭제 쿼리 -->
	<update id="logicalDeletePost">
	    update post
	    set po_delete = 1
	    where po_num = #{po_num}
	</update>
	
	<select id="selectCommunityList" resultType="CommunityVO">
		select * from community
	</select>
	
	<!-- po_me_num을 me_id로 보여지게 -->
	<select id="selectPostWithMemberId" resultType="kr.kh.petvely.model.vo.PostVO">
	    select p.po_num, p.po_title, p.po_content, p.po_date, p.po_co_num, m.me_id
	    from Post p
	    join Member m ON p.po_me_num = m.me_num
	</select>
	
	<!-- 추천 추가 -->
	<insert id="insertRecommend">
		insert into recommend(re_po_num, re_state)
		values(#{re_po_num},#{re_state})
	</insert>
	
	<!-- 추천 정보 조회 (게시글 번호로 조회)-->
	<select id="selectRecommend" resultType="RecommendVO">
		select * from recommend where re_po_num = #{re_po_num} and re_state = #{re_state}
	</select>
	
	
	<!-- 추천 삭제 -->
	<delete id="deleteRecommend">
		delete from recommend where re_num = #{re_num}
	</delete>
	
	<!-- 게시글의 추천수 및 비추천수 업데이트 -->
	<update id="updateRecommendCount">
	   SELECT 
		    (SELECT COUNT(*) FROM recommend WHERE re_po_num = #{po_num} AND re_state = 1) AS recommendCount,
		    (SELECT COUNT(*) FROM recommend WHERE re_po_num = #{po_num} AND re_state = -1) AS notRecommendCount
	   FROM post
	   WHERE po_num = #{po_num};
	</update>
	
</mapper>
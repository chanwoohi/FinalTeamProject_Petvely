<!DOCTYPE html>
<html 
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout.html}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<main layout:fragment="content" id="main">
		<form method="post" th:action="@{/walkmatepost/detail/{po_num}(po_num=*{po_num})}">
			<div th:object="${walkMatePost}">
				<div class="form-group">
					<label>ì œëª©</label>
					<input type="text" class="form-control" th:field="*{po_title}" readonly>
				</div>
				
				<!-- ë¡œê·¸ì¸ ê¸°ëŠ¥ ë¯¸êµ¬í˜„ìœ¼ë¡œ ì‘ì„±ì ì§ì ‘ ì…ë ¥í•´ì•¼í•¨... ì¶”í›„ ìˆ˜ì • -->
				<div class="form-group">
					<label>ì‘ì„±ì</label>
					<input type="text" class="form-control" th:field="*{me_id}" readonly>
				</div>
				
				<div class="form-group">
					<label>ë‚ ì§œ</label>
					<input type="date" class="form-control" th:field="*{wm_date}" readonly>
				</div>
				<div class="form-group">
					<label>ì‹œê°„</label>
					<input type="time" class="form-control" th:field="*{wm_time}" readonly>
				</div>
				<div class="form-group">
					<!-- ì´ë¯¸ì§€ ì§€ë„ë¥¼ í‘œì‹œí•  div ì…ë‹ˆë‹¤ -->
					<div id="staticMap" style="width:600px;height:350px;"></div>
				</div>
				<div class="form-group">
					<label>ë‚´ìš©</label>
					<textarea class="form-control" style="min-height: 400px; height: auto;" th:utext="*{po_content}" readonly>
					</textarea>
				</div>
				<div>
				<label>ì‘ì„±ì</label>
					<table class="table table-striped">
						<thead>
							<tr>
								<th>ì´ë¦„</th>
								<th>ë‚˜ì´</th>
								<th>ì„±ë³„</th>
								<th>ì¤‘ì„±í™” ì—¬ë¶€</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="item : ${detailPetList}">
								<td>
									<button th:text="${item.ani_name}"
									   th:onclick="'window.open(\'/animal/profile/' + ${item.ani_num} + '\', \'newwindow\', \'width=800,height=600,left=100,top=100\'); return false;'" >
								   </button>
								</td>
								<td th:text="${item.ani_age}"></td>
								<td th:text="${item.ani_gender}"></td>
								<td th:text="${item.ani_neutralization}"></td>
							</tr>
						</tbody>
					</table>
					<br>
					<label>ì‹ ì²­ì</label>
					<table class="table table-striped" id="myTable">
						<thead>
							<tr>
								<th>ì´ë¦„</th>
								<th>ë‚˜ì´</th>
								<th>ì„±ë³„</th>
								<th>ì¤‘ì„±í™” ì—¬ë¶€</th>
							</tr>
						</thead>
						<tbody>
							<tr th:if="${choicePetList == null or choicePetList.empty}">
				                <!-- ì´ ë¶€ë¶„ì´ ì•„ë¬´ í«ë„ ì—†ì„ ë•Œ í‘œì‹œë©ë‹ˆë‹¤. -->
				                <td>ì•„ì§ ì‹ ì²­í•œ í«ì´ ì—†ìŠµë‹ˆë‹¤.</td>
				            </tr>
							<tr th:each="item : ${choicePetList}">
								<td>
									<button th:text="${item.ani_name}"
									   		th:onclick="'window.open(\'/animal/profile/' + ${item.ani_num} + '\', \'newwindow\', \'width=800,height=600,left=100,top=100\'); return false;'" >
							    	</button>
								</td>
								<td th:text="${item.ani_age}"></td>
								<td th:text="${item.ani_gender}"></td>
								<td th:text="${item.ani_neutralization}"></td>
							</tr>
						</tbody>
					</table>
				</div>
				<!-- The Modal -->
				<div class="modal" id="myModal">
					<div class="modal-dialog">
						<div class="modal-content">
						
							<!-- Modal Header -->
							<div class="modal-header">
								<h4 class="modal-title">ë‚´ í« ë“±ë¡í•˜ê¸°</h4>
								<button type="button" class="close" data-dismiss="modal">&times;</button>
							</div>
							
							<!-- Modal body -->
							<div class="modal-body">
								ì‚°ì±…í•  í«ì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
							</div>
							
							<!-- Modal footer -->
							<div class="modal-footer">
								<button type="button" class="btn btn-outline-info" data-toggle="modal" data-target="#myModal2">ìˆ˜ë½</button>
								<button type="button" class="btn btn-outline-danger" data-dismiss="modal">ê±°ì ˆ</button>
							</div>
						
						</div>
					</div>
				</div>
				<div class="modal" id="myModal2">
					<div class="modal-dialog">
						<div class="modal-content">
						
							<!-- Modal Header -->
							<div class="modal-header">
								<h4 class="modal-title">ì‚°ì±… ë©”ì´íŠ¸ í« ë“±ë¡í•˜ê¸°</h4>
								<button type="button" class="close" data-dismiss="modal">&times;</button>
							</div>
							
							<!-- Modal body -->
							<div>
								<div class="modal-body">
									<table class="table table-striped">
										<thead>
											<tr>
												<th>ì„ íƒ</th>
												<th>ì´ë¦„</th>
												<th>ë‚˜ì´</th>
												<th>ì„±ë³„</th>
												<th>ì¤‘ì„±í™” ì—¬ë¶€</th>
											</tr>
										</thead>
										<tbody>
											<tr th:if="${petList == null or petList.empty}">
												<td>ë“±ë¡ëœ í«ì´ ì—†ìŠµë‹ˆë‹¤.</td>
												<td>
													<a class="btn btn-outline-warning" th:href="@{/animal/signup}">í« ë“±ë¡í•˜ê¸°</a>
												</td>
											</tr>
											
											<tr th:if="${petList != null}" th:each="item : ${petList}">
												<td>
													<input type="checkbox" name="check" value="ì„ íƒ" th:value="${item.ani_num}"/>
												</td>
												<td>
													<button th:text="${item.ani_name}"
									  					 	th:onclick="'window.open(\'/animal/profile/' + ${item.ani_num} + '\', \'newwindow\', \'width=800,height=600,left=100,top=100\'); return false;'" >
								   					</button>
												</td>
												<td th:text="${item.ani_age}"></td>
												<td th:text="${item.ani_gender}"></td>
												<td th:text="${item.ani_neutralization}"></td>
											</tr>
											
										</tbody>
									</table>
								</div>
								<br>
								
								<!-- Modal footer -->
								<div class="modal-footer">
									<button name="petEnroll" class="btn btn-outline-info" >ì‚°ì±… ë©”ì´íŠ¸ í« ë“±ë¡í•˜ê¸°</button>
									<button type="button" class="btn btn-outline-danger" data-dismiss="modal">ë‹«ê¸°</button>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div sec:authorize="isAuthenticated()">
					<a th:if="${bookmark}!=${po_num}" href="#" class="btn btn-outline-warning bookmark-btn" th:attr="data-url=@{/post/bookmark/insert/{po_num}(po_num=${po_num})}">ì¦ê²¨ì°¾ê¸°â­</a>
					<a th:if="${bookmark}==${po_num}" href="#" class="btn btn-warning bookmark-btn" th:attr="data-url=@{/post/bookmark/delete/{po_num}(po_num=${po_num})}">ì¦ê²¨ì°¾ê¸° ì·¨ì†Œâ­</a>
					<button type="button" class="btn btn-outline-info"
								    th:onclick="'window.open(\'/report/post/' + ${po_num} + '\', \'newwindow\', \'width=800,height=600,left=100,top=100\'); return false;'"
								    >ì‹ ê³ í•˜ê¸°ğŸš¨</button>
				</div>
				<div sec:authorize="isAnonymous()">
					<button type="button" class="anonymous-action">ì¦ê²¨ì°¾ê¸°â­</button>
					<button type="button" class="anonymous-action">ì‹ ê³ í•˜ê¸°ğŸš¨</button>
				</div>
				<br>
				<!-- ì‹ ì²­ì ì „ìš© -->
				<div sec:authorize="isAuthenticated()">
					<div th:if="${#authentication.principal.member.me_num} != ${walkMatePost.po_me_num}">
						<a class="btn btn-outline-info" data-toggle="modal" data-target="#myModal">ì‚°ì±… ë©”ì´íŠ¸ ì‹ ì²­í•˜ê¸°</a>
					</div>
				</div>
				<br>
				<!-- ê¸€ ì‘ì„±ì ì „ìš© -->
				<!-- ë¡œê·¸ì¸ ê¸°ëŠ¥ êµ¬í˜„ ì™„ë£Œë˜ë©´ ì‘ì„±ìë§Œ ë³´ì´ê²Œ ìˆ˜ì •í•  ê²ƒ -->
				<div sec:authorize="isAuthenticated()">
					<div th:if="${#authentication.principal.member.me_num} == ${walkMatePost.po_me_num}">
						<a class="btn btn-outline-info" th:href="@{/walkmatepost/approve/{po_num}(po_num=*{po_num})}">ì‚°ì±… ë©”ì´íŠ¸ ìˆ˜ë½í•˜ê¸°</a>
						<a class="btn btn-outline-primary" th:href="@{/walkmatepost/update/{po_num}(po_num=*{po_num})}">ìˆ˜ì •</a>
						<a class="btn btn-outline-warning" th:href="@{/walkmatepost/delete/{po_num}(po_num=*{po_num})}">ì‚­ì œ</a>
					</div>
				</div>
				<a class="btn btn-outline-dark" th:href="@{/walkmatepost/list}">ëª©ë¡ìœ¼ë¡œ</a>
				<div id="selectedPets"></div> <!-- selectedPetsë¥¼ ì¶œë ¥í•  ìš”ì†Œ ì¶”ê°€ -->
			</div>
		</form>

<!-- appkey ê°€ì ¸ì˜¤ê¸° -->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e141a54b3e32d6131dd17f72265325ab"></script>
<!-- servicesì™€ clusterer, drawing ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° -->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=APIKEY&libraries=services,clusterer,drawing"></script>
	<script>
    // ì„œë²„ì—ì„œ ì „ë‹¬ëœ latitudeì™€ longitude ê°’ì„ ì‚¬ìš©
	var latitude = /*[[${walkMatePost.latitude}]]*/;
	var longitude = /*[[${walkMatePost.longitude}]]*/;
	
    console.log("Latitude:", latitude);
    console.log("Longitude:", longitude);
    
    var marker = {
        position: new kakao.maps.LatLng(latitude, longitude),
        text: 'ì•½ì† ì¥ì†Œ!'
    };

    var staticMapContainer = document.getElementById('staticMap'), // ì´ë¯¸ì§€ ì§€ë„ë¥¼ í‘œì‹œí•  div
        staticMapOption = {
            center: new kakao.maps.LatLng(latitude, longitude), // ì´ë¯¸ì§€ ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
            level: 3, // ì´ë¯¸ì§€ ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
            marker: marker // ì´ë¯¸ì§€ ì§€ë„ì— í‘œì‹œí•  ë§ˆì»¤
        };

    // ì´ë¯¸ì§€ ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    var staticMap = new kakao.maps.StaticMap(staticMapContainer, staticMapOption);
	</script>
	<script>
		// myModal2ë¥¼ ì—´ ë•Œ myModalì„ ë‹«ëŠ” í•¨ìˆ˜
	    $('#myModal2').on('show.bs.modal', function () {
	        $('#myModal').modal('hide');
	    });
		
	    // í˜ì´ì§€ ë¡œë“œê°€ ì™„ë£Œëœ í›„ì— ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ë„ë¡ ì„¤ì •
	    document.addEventListener('DOMContentLoaded', function() {
	        const petEnrollButton = document.querySelector('button[name="petEnroll"]');
	
	        if (petEnrollButton) {
	            petEnrollButton.addEventListener('click', function(event) {
	                const checkedBoxes = document.querySelectorAll('input[name="check"]:checked');
	                
	                let selectedUserAniNums = [];
	                const selectedPetsEl = document.querySelector('#selectedPets');
	                selectedPetsEl.innerHTML = '';
	                let str = '';
	                
	                checkedBoxes.forEach(function(checkbox) {
	                    let aniNum = checkbox.value;  // ì²´í¬ëœ ì²´í¬ë°•ìŠ¤ì˜ valueê°€ ani_num
	                    let petData = {
	                        phsp_po_num: null,
	                        phsp_ani_num: aniNum
	                    };
	                    console.log(aniNum);
	                    selectedUserAniNums.push(petData);  // ê°ì²´ ë°°ì—´ì— ì¶”ê°€
	                    str += `<input type="text" name="selectedUserAniNums" value="${aniNum}"/>`;
	                });
	                
	                selectedPetsEl.innerHTML = str;
	                console.log(JSON.stringify(selectedUserAniNums));
	                
	                let selectedPets = [];
	                checkedBoxes.forEach(function(checkbox) {
	                    let row = checkbox.closest('tr');
	                    let petData = {
	                        name: row.querySelector('td:nth-child(2)').innerText,
	                        age: row.querySelector('td:nth-child(3)').innerText,
	                        gender: row.querySelector('td:nth-child(4)').innerText,
	                        neutralization: row.querySelector('td:nth-child(5)').innerText
	                    };
	                    selectedPets.push(petData);
	                });
	                
	                const hiddenInput = document.createElement('input');
	                hiddenInput.type = 'hidden';
	                hiddenInput.name = 'selectedPets';
	                hiddenInput.value = JSON.stringify(selectedPets);
	                document.querySelector('#main').appendChild(hiddenInput);
	                
	                console.log(selectedPets);
	                
	                const tbody = document.querySelector('#myTable tbody');
	                if (tbody) {
	                    tbody.innerHTML = '';  // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
	                    selectedPets.forEach(function(pet) {
	                        const newRow = document.createElement('tr');
	                        newRow.innerHTML = `
	                            <td>${pet.name}</td>
	                            <td>${pet.age}</td>
	                            <td>${pet.gender}</td>
	                            <td>${pet.neutralization}</td>
	                        `;
	                        tbody.appendChild(newRow);
	                    });
	                } else {
	                    console.error('#myTable tbody not found');
	                }
	            });
	        }
	    });
	    
	    document.addEventListener('DOMContentLoaded', function() {
	        const anonymousButtons = document.querySelectorAll('.anonymous-action');

	        anonymousButtons.forEach(button => {
	            button.addEventListener('click', function() {
	                if (confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
	                    window.location.href = '/member/login'; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
	                }
	                // ì•„ë‹ˆì˜¤ë¥¼ ì„ íƒí•  ê²½ìš° í˜ì´ì§€ì— ë¨¸ë¬´ë¦„
	            });
	        });
	    });
	    
	    document.querySelectorAll('.bookmark-btn').forEach(button => {
	        button.addEventListener('click', function(e) {
	            e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€
	            const url = this.getAttribute('data-url'); // data-url ì†ì„±ì—ì„œ URL ê°€ì ¸ì˜¤ê¸°

	            fetch(url, {
	                method: 'POST', // ì¦ê²¨ì°¾ê¸° ì¶”ê°€/ì‚­ì œëŠ” POST ìš”ì²­
	                headers: {
	                    'Content-Type': 'application/json',
	                    'Accept': 'application/json'
	                }
	            })
	            .then(response => response.json())
	            .then(data => {
	                alert(data.message); // ì„±ê³µ ë˜ëŠ” ì‹¤íŒ¨ ë©”ì‹œì§€
	                window.location.reload(); // ì‚¬ìš©ìê°€ í™•ì¸ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨
	            })
	            .catch(error => {
	                console.error('Error:', error);
	                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
	                window.location.reload(); // ì˜¤ë¥˜ ë°œìƒì‹œì—ë„ ìƒˆë¡œê³ ì¹¨
	            });
	        });
	    });
	    
	</script>
	</main>
</body>
</html>
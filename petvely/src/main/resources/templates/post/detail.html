
<!DOCTYPE html>
<html 
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout.html}">
<head>
<link rel="stylesheet" type="text/css" href="/css/project.css">
<meta charset="UTF-8">
<title>detail</title>
</head>
<body>
	<main layout:fragment="content">
		<div class="contents">
			<div th:if="${post != null}" th:object="${post}">
					<div class="article_header">
						<div class="title_area">
							<h3 class="title_text" th:text ="*{po_title}"></h3>
						</div>
							<div class="WriterInfo">
								<div class="profile-sectio">
								<img class="user-profile-icon" th:src="@{/image/user_profile.png}" alt="UserProfile">
								</div>
								<!-- ë‹‰ë„¤ì„ í´ë¦­ ì‹œ íŒì—… -->
			                    <div class="nickname-container" style="position: relative;">
			                        <div th:text="${post.me_id}" class="nickname" onclick="togglePopup()">ë‹‰ë„¤ì„</div>
			                        <div class="nickname-popup" id="nicknamePopup">
			                            <div class="popup-item">í”„ë¡œí•„ ë³´ê¸°</div>
			                            <div class="popup-item">ìª½ì§€ ë³´ë‚´ê¸°</div>
			                            <div class="popup-item">ì‹ ê³  í•˜ê¸°</div>
			                        </div>
			                       <div class="article_info">
									    <span class="date" th:text="${post.po_date != null ? #dates.format(post.po_date, 'yyyy-MM-dd') : 'ë‚ ì§œ ì—†ìŒ'}"></span>
									    &nbsp;ì¡°íšŒ <span class="count" th:text="*{po_viewCount}"></span>
							     	</div>
			                    </div>
					     </div>
				     	 <a href="#" data-state="1"
					       class="btn-up btn btn" 
					       th:classappend="${re_state != 1} ? '-outline-danger' : '-danger'">
					        ğŸ‘ì¶”ì²œ
					    </a>
					    &nbsp;
					    <a href="#" data-state="-1"
					       class="btn-down btn btn" 
					       th:classappend="${re_state != -1} ? '-outline-danger' : '-danger'">
					        ğŸ‘ë¹„ì¶”ì²œ
					    </a>
					    
					</div>
					<div class="main-contents">
							<div th:utext="*{po_content}"></div>
					</div>
				<div class="file">
				     <label>ì²¨ë¶€íŒŒì¼ :</label>
				    <div th:each="file : ${list}">
				        <a th:href="@{'/download/' + ${file.fi_name}}" 
				           class="form-control" 
				           th:download="${file.fi_ori_name}" 
				           th:text="${file.fi_ori_name}">
				        </a>
				    </div>
				</div>
				</div>
				<a class="btn btn-outline-info" th:href="@{/post/list/{po_num}(po_num=*{po_num})}">ëª©ë¡ìœ¼ë¡œ</a>
				<a class="btn btn-outline-info" th:href="@{/post/update/{po_num}(po_num=*{po_num})}">ìˆ˜ì •</a>
				<a class="btn btn-outline-info" th:href="@{/post/delete/{po_num}(po_num=*{po_num})}">ì‚­ì œ</a>
			</div>

	<script th:inline="javascript">
	// íŒì—… í† ê¸€ í•¨ìˆ˜
    function togglePopup() {
        const popup = document.getElementById('nicknamePopup');
        if (popup.style.display === 'none' || popup.style.display === '') {
            popup.style.display = 'block';  // íŒì—…ì„ ë³´ì—¬ì¤Œ
        } else {
            popup.style.display = 'none';  // íŒì—…ì„ ìˆ¨ê¹€
        }
    }

    // í˜ì´ì§€ ì™¸ë¶€ë¥¼ í´ë¦­í•˜ë©´ íŒì—…ì„ ë‹«ìŒ
    window.onclick = function(event) {
        const popup = document.getElementById('nicknamePopup');
        if (!event.target.matches('.nickname')) {
            if (popup.style.display === 'block') {
                popup.style.display = 'none';
            }
        }
    }
    // ì¶”ì²œ/ë¹„ì¶”ì²œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    $('.btn-up, .btn-down').click(function(e) {
        e.preventDefault();
        if (!checkLogin()) {
            return;
        }

        // ì¶”ì²œ: 1, ë¹„ì¶”ì²œ: -1 ìƒíƒœ
        let state = $(this).data('state');
        // Thymeleafì—ì„œ JS ë³€ìˆ˜ë¡œ ê²Œì‹œê¸€ ë²ˆí˜¸ë¥¼ ì „ë‹¬
        var num = /*[[${post.po_num}]]*/ "0";  
        // ê²Œì‹œê¸€ ë²ˆí˜¸ë¥¼ Thymeleafë¡œ ì „ë‹¬

        $.ajax({
            url: '/post/recommend',
            type: 'POST',
            dataType: 'json',
            data: {
                state: state,
                num: num
            },
            
            success: function(data) {
            	
                let res = data.result;
                if (res == 1) {
                    alert('ì¶”ì²œí–ˆìŠµë‹ˆë‹¤.');
                } else if (res == -1) {
                    alert('ë¹„ì¶”ì²œí–ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert(`${state == 1 ? 'ì¶”ì²œ' : 'ë¹„ì¶”ì²œ'}ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.`);
                }

                checkRecommendBtns(res);
                console.log(res);

                // ì—…ë°ì´íŠ¸ëœ ì¶”ì²œ/ë¹„ì¶”ì²œ ìˆ˜ ë°˜ì˜
                let post = data.post;
                $('.btn-up span').text(post.po_recommendCount);
                $('.btn-down span').text(post.po_notRecommendCount);
            },
            error: function(xhr) {
                if (xhr.status === 400) {  // 400 ì—ëŸ¬ ì²˜ë¦¬
                    let response = JSON.parse(xhr.responseText);
                    alert(response.error);  // "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." ë©”ì‹œì§€ ì¶œë ¥
                    location.href = '/member/login';  // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                } else {
                    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        });
    });

    // ì¶”ì²œ/ë¹„ì¶”ì²œ ë²„íŠ¼ì˜ ìƒíƒœì— ë”°ë¼ ìŠ¤íƒ€ì¼ ë³€ê²½
    function checkRecommendBtns(state) {
        $('.btn-up, .btn-down').removeClass('btn-danger');
        $('.btn-up, .btn-down').addClass('btn-outline-danger');
        if (state != 0) {
            $(state == 1 ? '.btn-up' : '.btn-down').removeClass('btn-outline-danger');
            $(state == 1 ? '.btn-up' : '.btn-down').addClass('btn-danger');
        }
    }

    // ë¡œê·¸ì¸ í™•ì¸ í•¨ìˆ˜
    function checkLogin(){
    	 // ë¡œê·¸ì¸ëœ ì‚¬ìš©ì IDë¥¼ Thymeleafë¥¼ í†µí•´ ê°€ì ¸ì˜´
        let userId = /*[[${#authentication.principal}]]*/ false;

		console.log("1:" + userId);
		
        if (userId == '') {  // ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ìƒíƒœ
            if (confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                location.href = '[[@{/member/login}]]';  // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                return false;
            } else {
                return false;
            }
        }
        return true;
    }
	</script>	
	</main>
</body>
</html>
